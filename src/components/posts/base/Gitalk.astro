---
import { COMMENT_CONFIG } from '~/config'

interface Props {
  id: string
  title: string
}

const { id, title } = Astro.props
---

<div id="gitalk-container" data-id={id} data-title={title}></div>

<script>
  import { COMMENT_CONFIG } from '~/config'
  const { gitalk } = COMMENT_CONFIG

  let observer: IntersectionObserver | null = null

  function initGitalk() {
    if (!gitalk) return

    import('gitalk/dist/gitalk.css')
    import('gitalk').then(({ default: Gitalk }) => {
      const gitalkComment = new Gitalk({
        clientID: gitalk.clientID,
        clientSecret: gitalk.clientSecret,
        repo: gitalk.repo,
        owner: gitalk.owner,
        admin: gitalk.admin,
        language: gitalk.language || 'zh-CN',
        perPage: gitalk.perPage || 5,
        pagerDirection: gitalk.pagerDirection || 'last',
        createIssueManually: gitalk.createIssueManually || false,
        distractionFreeMode: gitalk.distractionFreeMode || false,
        enableHotKey: gitalk.enableHotKey !== false,
        id: document.getElementById('gitalk-container')?.dataset.id || '',
        title: document.getElementById('gitalk-container')?.dataset.title || '',
      })
      gitalkComment.render('gitalk-container')
    })
  }

  // 使用 Intersection Observer 监听
  function setupObserver() {
    const container = document.getElementById('gitalk-container')
    if (!container) return

    // 清理之前的观察器
    if (observer) {
      observer.disconnect()
    }

    observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            initGitalk()
            observer?.disconnect()
            observer = null
          }
        })
      },
      {
        rootMargin: '300px',
        threshold: 0,
      }
    )

    observer.observe(container)
  }

  // 清理函数
  function cleanup() {
    if (observer) {
      observer.disconnect()
      observer = null
    }
  }

  // 初始检查
  setupObserver()

  // 监听页面导航事件
  document.addEventListener('astro:page-load', setupObserver)

  // 页面卸载时清理
  document.addEventListener('astro:before-preparation', cleanup)
  window.addEventListener('beforeunload', cleanup)
</script>

<style is:global>
  .markdown-body {
    font-family: 'CJKEmDash', 'Numbers', 'ShangguSansSC-VF', sans-serif !important;
    font-size: 0.875rem !important;
  }
  .dark .gt-container .gt-meta {
    border-color: var(--color-border) !important;
  }
</style>
