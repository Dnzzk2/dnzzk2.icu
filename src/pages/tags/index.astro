---
import PageTitle from '~/components/base/PageTitle.astro'
import { TAGS_CONFIG, POSTS_CONFIG, CATEGORY_ICONS } from '~/config'
import Layout from '~/layouts/Layout.astro'
import { getAllPosts } from '~/lib/data'
import { getAllTags } from '~/lib/data'

const { title, description, introduce } = TAGS_CONFIG

const [tagsMap, posts] = await Promise.all([getAllTags(), getAllPosts()])

const allTags = Object.entries(tagsMap)
  .map(([tag, count]) => ({
    name: tag,
    count,
  }))
  .sort((a, b) => {
    // 优先按分类排序
    const isACategory = POSTS_CONFIG.categories.includes(a.name)
    const isBCategory = POSTS_CONFIG.categories.includes(b.name)

    if (isACategory && !isBCategory) return -1
    if (!isACategory && isBCategory) return 1

    // 其次按数量降序
    return b.count - a.count
  })
---

<Layout {title} {description}>
  <div class="relative z-[1] py-8 pb-10 px-6 sm:px-8">
    <!-- 标题区域 -->
    <div class="mb-12">
      <PageTitle {title} {introduce} />

      <!-- 统计信息 -->
      <div class="mt-6 flex items-center gap-6 text-sm text-muted-foreground">
        <span class="flex items-center gap-1.5">
          <span class="icon-[ph--hash] size-4"></span>
          共{allTags.length}个标签
        </span>
        <span class="flex items-center gap-1.5">
          <span class="icon-[ph--article] size-4"></span>
          共{posts.length}篇文章
        </span>
      </div>
    </div>

    <!-- 统一标签云 -->
    <div class="flex flex-wrap gap-2 sm:gap-3 fade-up" data-astro-transition="animate">
      {
        allTags.map((tag) => {
          const isCategory = POSTS_CONFIG.categories.includes(tag.name)
          const icon = isCategory ? CATEGORY_ICONS[tag.name] || 'icon-[ph--folder-open-fill]' : 'icon-[ph--hash]'

          return (
            <a
              href={`/tags/${tag.name}`}
              class={`group inline-flex items-center gap-1.5 px-3 py-1.5 text-sm border  transition-all duration-300 ${
                isCategory
                  ? 'bg-primary/10 border-primary/20 hover:bg-primary/20 hover:border-primary/30 text-primary'
                  : 'bg-muted/50 border-transparent hover:border-primary/20 hover:bg-primary/5 text-foreground/80 hover:text-primary'
              }`}
            >
              <span
                class={`${icon} w-3.5 h-3.5 transition-colors ${isCategory ? 'text-primary' : 'text-muted-foreground/50 group-hover:text-primary/70'}`}
              />
              <span class="font-medium">{tag.name}</span>
              <span
                class={`ml-1 text-xs transition-colors ${isCategory ? 'text-primary/60 group-hover:text-primary/80' : 'text-muted-foreground/40 group-hover:text-primary/40'}`}
              >
                {tag.count}
              </span>
            </a>
          )
        })
      }
    </div>

    {/* 空状态 */}
    {
      allTags.length === 0 && (
        <div class="text-center py-12">
          <span class="icon-[ph--tag] size-12 text-muted-foreground/50 mx-auto block mb-4" />
          <p class="text-muted-foreground">啊哦，暂时没有标签</p>
        </div>
      )
    }
  </div>
</Layout>
